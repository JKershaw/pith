# Benchmark Run: 2026-01-02 v2 (Query Mode Self-Test)

## Configuration

- **Repository**: Pith (self-test)
- **Size**: 49 files extracted, ~25k lines (source only)
- **Pith version**: 5a9ee15
- **Model**: qwen/qwen-turbo
- **Tasks**: 15 (3 per category, full task bank)
- **Mode**: **Query Mode** (`POST /query`) - Uses navigator for file selection and answer synthesis

## Pipeline Metrics

| Stage      | Time              | Notes                                                |
| ---------- | ----------------- | ---------------------------------------------------- |
| Extraction | 15.1s             | 49 files extracted                                   |
| Build      | 4.0s              | 176 nodes created (49 file, 116 function, 11 module) |
| Generation | 291.9s (~4.9 min) | 60 nodes with prose (files + modules)                |
| **Total**  | ~311s (~5.2 min)  | Full pipeline with prose                             |

- Nodes created: 49 file, 116 function, 11 module (176 total)
- Nodes with prose: 60 (files + modules)
- Estimated cost: ~$0.50-1.00 (qwen-turbo)

---

## Task Results

### Architecture Tasks (A1-A3)

#### A1: Main Components

**Question**: "What are the main components of this codebase and how do they interact?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 3/5          | 4/5       |
| **Total**    | **16/20**    | **19/20** |

**Winner**: Control
**Files selected**: 7 main modules (API, Builder, CLI, Config, DB, Generator, Query)
**Notes**: Pith correctly identified 7 main components with line references (e.g., `bundleContext:107-216`, `createApp:890-1500`). Control provided more comprehensive breakdown with 9+ components including detailed interaction diagrams and phase markers.

---

#### A2: Data Flow

**Question**: "Explain the data flow from file input to wiki output."

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 5/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **19/20**    | **19/20** |

**Winner**: Tie
**Files selected**: Extractor, Builder, Generator modules
**Notes**: **Excellent Pith performance!** Both provided complete 4-stage pipeline with specific line references. Pith cited `extractFile:464-704`, `findFiles:363-398`, `callLLM:732-830`, `parseLLMResponse:358-441`. Comparable depth and accuracy.

---

#### A3: Design Patterns

**Question**: "What design patterns are used in this codebase?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **17/20**    | **19/20** |

**Winner**: Control
**Files selected**: patterns.ts and related files
**Notes**: Pith correctly identified 4 detected patterns (Retry, Cache, Builder, Singleton) with line references and confidence levels. Control found 20+ architectural patterns including Factory, Repository, Middleware, AST Visitor, Strategy, and more.

---

### Specific Behavior Tasks (B1-B3)

#### B1: Extraction Cache

**Question**: "How does the extraction cache determine if a file needs re-extraction?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 5/5          | 5/5       |
| Conciseness  | 5/5          | 5/5       |
| **Total**    | **20/20**    | **20/20** |

**Winner**: Tie
**Files selected**: cache.ts, patterns.ts, ast.ts
**Notes**: **Perfect scores for both!** Pith correctly identified SHA-256 hashing at `getFileHash:26-30`, `shouldExtract:85-100`. Both explained the exact decision logic and hash comparison mechanism.

---

#### B2: buildPrompt Function

**Question**: "How does buildPrompt construct LLM prompts for different node types?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 3/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **15/20**    | **19/20** |

**Winner**: Control
**Files selected**: generator/index.ts, builder/index.ts
**Notes**: Pith mentioned buildPrompt at lines 83-91 and referenced helper functions but lacked detail on the actual dispatch logic. Control documented full type-based routing: `buildFilePrompt()` (131-276) vs `buildModulePrompt()` (284-352) with prompt template details.

---

#### B3: LLM Retry Logic

**Question**: "What is the retry logic in the LLM client and what triggers a retry?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 5/5          | 5/5       |
| Conciseness  | 5/5          | 5/5       |
| **Total**    | **20/20**    | **20/20** |

**Winner**: Tie
**Files selected**: generator/index.ts
**Notes**: **Perfect scores for both!** Pith correctly identified all: `maxRetries=3` (line 738), timeout 30s (line 739), exponential backoff `2^attempt * 1000ms` (lines 792, 819), retryable conditions in `isRetryableError` (lines 703-724).

---

### Relationship Tasks (R1-R3)

#### R1: WikiNode Impact

**Question**: "What files would be affected if I changed the WikiNode interface?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **17/20**    | **19/20** |

**Winner**: Control
**Files selected**: builder, query, generator, api, cli modules
**Notes**: Pith identified 10 affected files with explanations of why each needs changes. Control found 17 files with exact line references for type usage locations (e.g., `WikiNode` interface at builder/index.ts:116-152).

---

#### R2: API to Database

**Question**: "How do the API routes connect to the database layer?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 3/5          | 5/5       |
| Specificity  | 3/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **14/20**    | **19/20** |

**Winner**: Control
**Files selected**: api/index.ts, db/index.ts
**Notes**: Pith mentioned `getDb()` singleton but lacked specific route-to-collection mappings and used hedging language ("likely uses"). Control traced 6 complete endpoints with specific DB operations at each route.

---

#### R3: extractFile Consumers

**Question**: "What are all the consumers of the extractFile function?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 3/5          | 5/5       |
| Completeness | 2/5          | 5/5       |
| Specificity  | 2/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **11/20**    | **19/20** |

**Winner**: Control
**Files selected**: cross-file-calls.ts, test files
**Notes**: **Key limitation exposed.** Pith listed 4 files as "potential consumers" with hedging language and no line numbers. Control found 1 production consumer (cli:185) + 56 test call sites with exact line numbers across 3 test files. Pith cannot trace function-level consumers.

---

### Debugging Tasks (D1-D3)

#### D1: Empty Prose

**Question**: "Generation completes but some nodes have empty prose. What should I investigate?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **16/20**    | **19/20** |

**Winner**: Control
**Files selected**: generator/index.ts, builder/index.ts
**Notes**: Pith identified relevant functions (`generateProse:846-869`, `parseLLMResponse:358-441`, `callLLM:732-830`). Control provided deeper root cause analysis: `parseLLMResponse` only validates `summary` and `purpose` (lines 383-388), allowing incomplete responses through.

---

#### D2: Slow Generation

**Question**: "Why might the generate command be slow?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **16/20**    | **19/20** |

**Winner**: Control
**Files selected**: cli/index.ts, generator/index.ts
**Notes**: Pith identified LLM latency, retry logic, and timeout configurations. Control found the **critical bottleneck**: sequential processing loop at cli/index.ts:602-644 (no `Promise.allSettled()`) plus exponential backoff delays (792, 819) and full DB scans (api/index.ts:914).

---

#### D3: 404 for Existing File

**Question**: "API returns 404 for a file that exists. What could cause this?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **18/20**    | **19/20** |

**Winner**: Control
**Files selected**: api/index.ts, fuzzy.ts
**Notes**: Pith identified 8 specific causes including fuzzy matching thresholds (`AUTO_MATCH_THRESHOLD`, `confidence >= 0.4`), path resolution, and database lookup issues. Control provided additional threshold analysis with confidence ranges (0.4-0.7 returns 404 with suggestions).

---

### Modification Tasks (M1-M3)

#### M1: JavaScript Support

**Question**: "How would I add support for JavaScript (.js) files in addition to TypeScript?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 3/5          | 5/5       |
| Specificity  | 3/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **14/20**    | **19/20** |

**Winner**: Control
**Files selected**: ast.ts, config.ts
**Notes**: Pith found key location at `findFiles:365` and mentioned updating include patterns. Control found **all locations** requiring changes: ast.ts (lines 365, 380, 737), config/index.ts (lines 45-51), builder/index.ts (lines 614, 651-689 for test file patterns).

---

#### M2: Rate Limiting

**Question**: "How would I add rate limiting to the API endpoints?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **16/20**    | **19/20** |

**Winner**: Control
**Files selected**: api/index.ts
**Notes**: Both provided good `express-rate-limit` guidance. Pith identified `createApp:893-1568` and provided working middleware code. Control found specific insertion point at line 897 and listed all 6 endpoints needing protection with different rate limits for expensive `/query` endpoint.

---

#### M3: Add Complexity Field

**Question**: "I want to add a 'complexity' field to WikiNode. What files need changes?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **17/20**    | **19/20** |

**Winner**: Control
**Files selected**: builder/index.ts, query/index.ts, test files
**Notes**: Pith identified 4 main files needing changes with function references. Control provided exact locations: interface (122-138), buildFileNode (167-173), buildFunctionNode (291-299), computeMetadata (587-604), plus helper function implementation.

---

## Summary

### Overall Scores

| Metric            | Pith (Query)        | Control             |
| ----------------- | ------------------- | ------------------- |
| **Average score** | **16.4/20 (82.0%)** | **19.1/20 (95.5%)** |
| Win/Loss/Tie      | 0-12-3              | 12-0-3              |

### Score Breakdown by Category

| Category             | Pith Avg | Control Avg | Gap  |
| -------------------- | -------- | ----------- | ---- |
| Architecture (A1-A3) | 17.3     | 19.0        | -1.7 |
| Behavior (B1-B3)     | 18.3     | 19.7        | -1.4 |
| Relationship (R1-R3) | 14.0     | 19.0        | -5.0 |
| Debugging (D1-D3)    | 16.7     | 19.0        | -2.3 |
| Modification (M1-M3) | 15.7     | 19.0        | -3.3 |

### Score Breakdown by Criterion

| Criterion    | Pith Avg | Control Avg | Gap  |
| ------------ | -------- | ----------- | ---- |
| Correctness  | 4.5      | 5.0         | -0.5 |
| Completeness | 3.9      | 5.0         | -1.1 |
| Specificity  | 4.0      | 5.0         | -1.0 |
| Conciseness  | 4.1      | 4.2         | -0.1 |

### Comparison to Previous Benchmarks

| Metric          | 2026-01-01 Query Mode | 2026-01-02 v1 | This Run (v2) | Delta from v1 |
| --------------- | --------------------- | ------------- | ------------- | ------------- |
| Pith Average    | 73.5%                 | 82.0%         | 82.0%         | 0%            |
| Control Average | 95.0%                 | 95.5%         | 95.5%         | 0%            |
| Gap             | 21.5%                 | 13.5%         | 13.5%         | 0%            |
| Ties            | 0                     | 3             | 3             | 0             |

---

## Key Observations

### 1. Consistent Performance with Previous Run

- Results match 2026-01-02 v1 benchmark almost exactly
- Three perfect ties maintained (A2, B1, B3)
- Gap to Control stable at 13.5%

### 2. Strengths Confirmed

- **Technical behavior tasks** (B1, B3): Perfect 20/20 ties
- **Data flow explanation** (A2): Excellent line references and pipeline clarity
- **Debugging guidance** (D3): Strong with 8 specific causes

### 3. Persistent Gaps

| Weakness Area              | Task | Pith Score | Control Score | Root Cause                            |
| -------------------------- | ---- | ---------- | ------------- | ------------------------------------- |
| Function consumer tracking | R3   | 11/20      | 19/20         | Pith lacks function-level call graphs |
| Modification enumeration   | M1   | 14/20      | 19/20         | Cannot search for hardcoded values    |
| API-Database tracing       | R2   | 14/20      | 19/20         | Vague on specific route mappings      |

### 4. Categories by Performance

| Category         | Pith Performance | Notes                             |
| ---------------- | ---------------- | --------------------------------- |
| Behavior (B)     | Strong (91.5%)   | Technical details well-extracted  |
| Architecture (A) | Good (86.5%)     | Overview capability solid         |
| Debugging (D)    | Good (83.5%)     | Identifies functions, misses root |
| Modification (M) | Moderate (78.5%) | Finds some locations, not all     |
| Relationship (R) | Weak (70.0%)     | Function-level tracking missing   |

---

## Information Gap Analysis

### Information Type Comparison

| Information Type            | Pith | Control | Gap Severity |
| --------------------------- | :--: | :-----: | :----------: |
| Module/file names           |  ✅  |   ✅    |     None     |
| One-line summary            |  ✅  | Partial |     None     |
| Purpose description         |  ✅  | Partial |     None     |
| Line number references      |  ✅  |   ✅    |     None     |
| Function signatures         |  ✅  |   ✅    |     None     |
| Implementation details      |  ✅  |   ✅    |    Minor     |
| Function-level consumers    |  ❌  |   ✅    |   Critical   |
| Complete change enumeration |  ⚠️  |   ✅    |     High     |
| Route-to-DB mapping         |  ⚠️  |   ✅    |    Medium    |
| Comparative analysis        |  ⚠️  |   ✅    |    Medium    |

---

## Recommendations

### Priority Improvements for Pith

| Priority | Improvement                        | Impact                      | Addresses |
| -------- | ---------------------------------- | --------------------------- | --------- |
| High     | Add function consumer index        | Fixes R3-type queries       | R3        |
| High     | Cross-reference hardcoded patterns | Improves M1-type tasks      | M1        |
| Medium   | Trace API routes to DB operations  | Improves R2 specificity     | R2        |
| Medium   | Add comparative debugging analysis | Improves D2 root cause      | D2        |
| Low      | Tune query synthesis prompts       | Further improve specificity | All       |

---

## Revision History

| Date       | Change                                 | Author |
| ---------- | -------------------------------------- | ------ |
| 2026-01-02 | v2 benchmark confirming 82% Pith score | Claude |
