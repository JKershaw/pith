# Benchmark Run: 2026-01-02 (Query Mode Self-Test)

## Configuration

- **Repository**: Pith (self-test)
- **Size**: 49 files extracted, ~25k lines (source only)
- **Pith version**: 973c489
- **Model**: qwen/qwen-turbo
- **Tasks**: 15 (3 per category, full task bank)
- **Mode**: **Query Mode** (`POST /query`) - Uses navigator for file selection and answer synthesis

## Pipeline Metrics

| Stage      | Time              | Notes                                                |
| ---------- | ----------------- | ---------------------------------------------------- |
| Extraction | 18.3s (15.0s int) | 49 files extracted                                   |
| Build      | 7.3s (4.0s int)   | 178 nodes created (49 file, 118 function, 11 module) |
| Generation | 301.6s (~5.0 min) | 60 nodes with prose (files + modules)                |
| **Total**  | ~327s (~5.5 min)  | Full pipeline with prose                             |

- Nodes created: 49 file, 118 function, 11 module (178 total)
- Nodes with prose: 60 (files + modules)
- Estimated cost: ~$0.50-1.00 (qwen-turbo)

---

## Task Results

### Architecture Tasks (A1-A3)

#### A1: Main Components

**Question**: "What are the main components of this codebase and how do they interact?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 3/5          | 4/5       |
| **Total**    | **15/20**    | **19/20** |

**Winner**: Control
**Files selected**: 13 (index.ts, api, builder, cli, generator, query modules)
**Candidates considered**: Navigator mode - explored full structure
**Notes**: Pith correctly identified 7 main components (CLI, Extractor, Builder, Generator, Query, API, DB). Control provided more comprehensive breakdown with 9 components including Config and Error handling, plus detailed interaction diagram.

---

#### A2: Data Flow

**Question**: "Explain the data flow from file input to wiki output."

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 5/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **19/20**    | **19/20** |

**Winner**: Tie
**Files selected**: Extractor, Builder, Generator modules
**Notes**: **Excellent Pith performance!** Both provided complete 4-stage pipeline with specific line references. Pith cited `extractFile:464-704`, `findFiles:363-398`, `callLLM:732-830`, `parseLLMResponse:358-441`. Comparable depth.

---

#### A3: Design Patterns

**Question**: "What design patterns are used in this codebase?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 5/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **18/20**    | **19/20** |

**Winner**: Control
**Files selected**: patterns.ts and related files
**Notes**: Pith correctly identified 4 detected patterns (Retry, Cache, Builder, Singleton) with line references. Answer correctly focused on patterns the codebase _detects_ rather than patterns it _uses_. Control identified additional architectural patterns (Repository, Factory, Template Method).

---

### Specific Behavior Tasks (B1-B3)

#### B1: Extraction Cache

**Question**: "How does the extraction cache determine if a file needs re-extraction?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 5/5          | 5/5       |
| Conciseness  | 5/5          | 5/5       |
| **Total**    | **20/20**    | **20/20** |

**Winner**: Tie
**Files selected**: cache.ts, patterns.ts, ast.ts
**Notes**: **Perfect scores for both!** Pith correctly identified SHA-256 hashing at `getFileHash:26-30`, `shouldExtract:85-100`. Both explained the exact decision logic and hash comparison mechanism.

---

#### B2: buildPrompt Function

**Question**: "How does buildPrompt construct LLM prompts for different node types?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 3/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **15/20**    | **19/20** |

**Winner**: Control
**Files selected**: generator/index.ts, builder/index.ts
**Notes**: Pith mentioned buildPrompt at lines 83-91 and helper functions but lacked detail on the actual dispatch logic. Control documented full type-based routing and prompt templates.

---

#### B3: LLM Retry Logic

**Question**: "What is the retry logic in the LLM client and what triggers a retry?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 5/5          | 5/5       |
| Conciseness  | 5/5          | 5/5       |
| **Total**    | **20/20**    | **20/20** |

**Winner**: Tie
**Files selected**: generator/index.ts
**Notes**: **Perfect scores for both!** Pith correctly identified all: `maxRetries=3` (line 738), timeout 30s (line 739), exponential backoff `2^attempt * 1000ms` (lines 792, 819), retryable conditions in `isRetryableError` (lines 703-724). Excellent improvement from previous benchmark.

---

### Relationship Tasks (R1-R3)

#### R1: WikiNode Impact

**Question**: "What files would be affected if I changed the WikiNode interface?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **18/20**    | **19/20** |

**Winner**: Control
**Files selected**: builder, query, generator, api, cli modules
**Notes**: Pith identified 10 affected files with explanations of why each needs changes. Control was slightly more specific with line numbers for type usage locations.

---

#### R2: API to Database

**Question**: "How do the API routes connect to the database layer?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 3/5          | 5/5       |
| Specificity  | 3/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **14/20**    | **19/20** |

**Winner**: Control
**Files selected**: api/index.ts, db/index.ts
**Notes**: Pith mentioned `getDb` singleton but lacked specific route-to-collection mappings. Answer was somewhat vague ("likely uses this connection"). Control traced complete flow with 5 specific route mappings.

---

#### R3: extractFile Consumers

**Question**: "What are all the consumers of the extractFile function?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 3/5          | 5/5       |
| Completeness | 2/5          | 5/5       |
| Specificity  | 2/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **11/20**    | **19/20** |

**Winner**: Control
**Files selected**: cross-file-calls.ts, test files
**Notes**: **Key limitation exposed.** Pith listed 5 files as "potential consumers" without line numbers and hedged with "may import." Control found 1 production consumer (cli:185) + 47 test call sites with exact line numbers. Pith cannot trace function-level consumers.

---

### Debugging Tasks (D1-D3)

#### D1: Empty Prose

**Question**: "Generation completes but some nodes have empty prose. What should I investigate?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **16/20**    | **19/20** |

**Winner**: Control
**Files selected**: generator/index.ts, builder/index.ts
**Notes**: Pith identified relevant functions (`generateProse:846-869`, `parseLLMResponse:358-441`, `callLLM:732-830`). Control provided more specific root cause analysis.

---

#### D2: Slow Generation

**Question**: "Why might the generate command be slow?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **16/20**    | **19/20** |

**Winner**: Control
**Files selected**: cli/index.ts, generator/index.ts
**Notes**: Pith identified LLM latency, retry logic, and timeout. Control found the **critical bottleneck**: sequential processing in generate vs BATCH_SIZE=4 in extract. Pith missed this key insight.

---

#### D3: 404 for Existing File

**Question**: "API returns 404 for a file that exists. What could cause this?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 5/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **18/20**    | **19/20** |

**Winner**: Control
**Files selected**: api/index.ts, db/index.ts
**Notes**: Pith identified 6 specific causes including path format, fuzzy matching thresholds, and database query issues. Very close to Control's answer. Strong performance.

---

### Modification Tasks (M1-M3)

#### M1: JavaScript Support

**Question**: "How would I add support for JavaScript (.js) files in addition to TypeScript?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 2/5          | 5/5       |
| Specificity  | 3/5          | 5/5       |
| Conciseness  | 4/5          | 3/5       |
| **Total**    | **13/20**    | **18/20** |

**Winner**: Control
**Files selected**: ast.ts, config.ts
**Notes**: Pith found key location at `findFiles:365` but only mentioned 3-4 locations. Control found **13 specific locations** across config, AST, generator, API, eslint, package.json, and tsconfig with exact line numbers. Demonstrates Pith's limitation on modification enumeration.

---

#### M2: Rate Limiting

**Question**: "How would I add rate limiting to the API endpoints?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 4/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **16/20**    | **19/20** |

**Winner**: Control
**Files selected**: api/index.ts
**Notes**: Pith provided good general guidance with express-rate-limit example and identified `createApp:893-1568`. Control found specific insertion point and listed all 5 routes needing protection.

---

#### M3: Add Complexity Field

**Question**: "I want to add a 'complexity' field to WikiNode. What files need changes?"

| Criterion    | Pith (Query) | Control   |
| ------------ | ------------ | --------- |
| Correctness  | 5/5          | 5/5       |
| Completeness | 4/5          | 5/5       |
| Specificity  | 4/5          | 5/5       |
| Conciseness  | 4/5          | 4/5       |
| **Total**    | **17/20**    | **19/20** |

**Winner**: Control
**Files selected**: builder/index.ts, query/index.ts, test files
**Notes**: Pith identified 5 files needing changes with function references. Control more precise with exact line numbers for interface definition and builder functions.

---

## Summary

### Overall Scores

| Metric            | Pith (Query)        | Control             |
| ----------------- | ------------------- | ------------------- |
| **Average score** | **16.4/20 (82.0%)** | **19.1/20 (95.5%)** |
| Win/Loss/Tie      | 0-12-3              | 12-0-3              |

### Score Breakdown by Category

| Category             | Pith Avg | Control Avg | Gap  |
| -------------------- | -------- | ----------- | ---- |
| Architecture (A1-A3) | 17.3     | 19.0        | -1.7 |
| Behavior (B1-B3)     | 18.3     | 19.7        | -1.4 |
| Relationship (R1-R3) | 14.3     | 19.0        | -4.7 |
| Debugging (D1-D3)    | 16.7     | 19.0        | -2.3 |
| Modification (M1-M3) | 15.3     | 18.7        | -3.4 |

### Score Breakdown by Criterion

| Criterion    | Pith Avg | Control Avg | Gap  |
| ------------ | -------- | ----------- | ---- |
| Correctness  | 4.4      | 5.0         | -0.6 |
| Completeness | 3.9      | 5.0         | -1.1 |
| Specificity  | 4.0      | 5.0         | -1.0 |
| Conciseness  | 4.1      | 4.1         | 0.0  |

### Comparison to Previous Benchmarks

| Metric          | Query Mode (2026-01-01) | This Run (2026-01-02) | Delta           |
| --------------- | ----------------------- | --------------------- | --------------- |
| Pith Average    | 14.7/20 (73.5%)         | 16.4/20 (82.0%)       | **+8.5%**       |
| Control Average | 19.0/20 (95.0%)         | 19.1/20 (95.5%)       | +0.5%           |
| Gap             | -4.3 points (21.5%)     | -2.7 points (13.5%)   | **Improved 8%** |
| Ties            | 0                       | 3                     | **+3 ties**     |

---

## Key Improvements from Previous Run

### 1. Three Perfect Ties (A2, B1, B3)

- **A2 (Data Flow)**: Pith now provides complete pipeline with line references
- **B1 (Cache Logic)**: Both scored 20/20 on technical detail
- **B3 (Retry Logic)**: Pith correctly identified all retry conditions with exact line numbers

### 2. Significant Score Improvement

- Overall: 73.5% → **82.0%** (+8.5 percentage points)
- Gap to Control narrowed: 21.5% → **13.5%**

### 3. Better Line Number References

- B3 now includes specific lines: 703-724, 738, 739, 752, 792, 819
- D3 includes route lines and threshold references
- M3 includes function line ranges

---

## Persistent Gaps

### 1. Function-Level Consumer Tracking (R3)

- Pith: "potential consumers" with no line numbers
- Control: 1 production + 47 test call sites with exact lines
- **Impact**: Critical for refactoring tasks

### 2. Modification Enumeration (M1)

- Pith: Found 3-4 locations
- Control: Found 13 specific locations with line numbers
- **Impact**: Incomplete for modification planning

### 3. Comparative Analysis (D2)

- Pith: Listed general slowness causes
- Control: Found key bottleneck (sequential vs batch)
- **Impact**: Misses actionable insights

---

## Information Gap Analysis

### Information Type Comparison

| Information Type            | Pith | Control | Gap Severity |
| --------------------------- | :--: | :-----: | :----------: |
| Module/file names           |  ✅  |   ✅    |     None     |
| One-line summary            |  ✅  | Partial |     None     |
| Purpose description         |  ✅  | Partial |     None     |
| Line number references      |  ✅  |   ✅    |   Improved   |
| Function signatures         |  ✅  |   ✅    |     None     |
| Implementation details      |  ✅  |   ✅    |    Minor     |
| Function-level consumers    |  ❌  |   ✅    |   Critical   |
| Complete change enumeration |  ⚠️  |   ✅    |     High     |
| Comparative analysis        |  ⚠️  |   ✅    |    Medium    |

---

## Key Conclusions

### 1. Significant Improvement Over Previous Run

- **+8.5% absolute improvement** in Pith scores
- **3 tasks achieved ties** (up from 0)
- Line number references now consistently provided

### 2. Query Mode Maturation

- Navigator mode effectively selects relevant files
- Synthesis quality improved with better specificity
- Technical behavior tasks (B1, B3) now match Control

### 3. Remaining Limitations

- Function consumer tracking (R3) remains critical gap
- Modification task enumeration (M1) still incomplete
- Comparative debugging insights (D2) need improvement

### 4. Recommendations

| Priority | Improvement                      | Impact                         |
| -------- | -------------------------------- | ------------------------------ |
| High     | Add function consumer index      | Fixes R3-type queries          |
| High     | Cross-reference hardcoded values | Improves M1-type tasks         |
| Medium   | Add comparative analysis         | Improves debugging specificity |
| Low      | Tune query synthesis prompts     | Further improve tie rate       |

---

## Revision History

| Date       | Change                                        | Author |
| ---------- | --------------------------------------------- | ------ |
| 2026-01-02 | Query Mode benchmark showing 8.5% improvement | Claude |
