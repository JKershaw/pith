# P0.2: Code Snippets Implementation Plan

**Goal**: Add first 10-20 lines of each function to the wiki output, addressing the Critical gap identified in benchmarks.

**Expected Impact**: +2-3 points on benchmark (addresses Critical "code snippets" gap)

---

## Design Decisions

### Snippet Length
- **Default**: 15 lines (middle ground between 10-20)
- **Rationale**: Enough to show function logic, not so much it bloats context
- **Truncation**: Add `...` marker if function is longer

### What to Include
- Full function text up to line limit (not just body)
- Preserves signature context
- Shows opening logic patterns

### Storage Location
- Add `codeSnippet` to AST `Function` interface
- Add `codeSnippet` to builder `FunctionDetails` interface
- Include in generator prompt

---

## Implementation Steps

### Step 1: Update AST Function Interface
**File**: `src/extractor/ast.ts`

Add to `Function` interface (line 42-51):
```typescript
export interface Function {
  name: string;
  signature: string;
  params: Param[];
  returnType: string;
  isAsync: boolean;
  isExported: boolean;
  startLine: number;
  endLine: number;
  codeSnippet: string;  // NEW: First N lines of function
}
```

### Step 2: Extract Code Snippet
**File**: `src/extractor/ast.ts`

Add helper function:
```typescript
const SNIPPET_MAX_LINES = 15;

function getCodeSnippet(func: FunctionDeclaration, maxLines = SNIPPET_MAX_LINES): string {
  const fullText = func.getText();
  const lines = fullText.split('\n');

  if (lines.length <= maxLines) {
    return fullText;
  }

  return lines.slice(0, maxLines).join('\n') + '\n  // ... (' + (lines.length - maxLines) + ' more lines)';
}
```

Update function extraction (line 308-322):
```typescript
const functions: Function[] = sourceFile.getFunctions().map((func) => ({
  // ... existing fields ...
  codeSnippet: getCodeSnippet(func),
}));
```

### Step 3: Update Builder FunctionDetails
**File**: `src/builder/index.ts`

Add to `FunctionDetails` interface:
```typescript
export interface FunctionDetails {
  name: string;
  signature: string;
  startLine: number;
  endLine: number;
  isAsync: boolean;
  isExported: boolean;
  codeSnippet: string;  // NEW
}
```

Update `buildFileNode` to pass through:
```typescript
const functions: FunctionDetails[] = extracted.functions.map((f) => ({
  // ... existing fields ...
  codeSnippet: f.codeSnippet,
}));
```

### Step 4: Update Generator Prompt
**File**: `src/generator/index.ts`

Update `formatFunctionForPrompt` to include snippet:
```typescript
function formatFunctionForPrompt(func: FunctionDetails): string {
  const header = `  - ${func.name} (lines ${func.startLine}-${func.endLine}):`;
  return `${header}\n\`\`\`typescript\n${func.codeSnippet}\n\`\`\``;
}
```

### Step 5: Also Update Class Methods
**File**: `src/extractor/ast.ts`

Apply same pattern to class method extraction (lines 327-341).

---

## Files Changed

| File | Changes |
|------|---------|
| `src/extractor/ast.ts` | Add `codeSnippet` to Function, add helper, update extraction |
| `src/builder/index.ts` | Add `codeSnippet` to FunctionDetails, pass through in buildFileNode |
| `src/generator/index.ts` | Update `formatFunctionForPrompt` to show snippet |

---

## Testing

1. Run `npm test` - all tests should pass
2. Run `pith extract . && pith build`
3. Verify snippets in database:
   ```bash
   node --experimental-strip-types -e "
   import { getDb } from './src/db/index.ts';
   const db = await getDb('.pith/data');
   const nodes = db.collection('nodes');
   const file = await nodes.findOne({ type: 'file' });
   console.log(file?.raw?.functions?.[0]?.codeSnippet);
   "
   ```
4. Verify prompt includes snippets

---

## Example Output

Before:
```text
FUNCTIONS:
  - callLLM (lines 431-527): export async function callLLM(...)
```

After:
```text
FUNCTIONS:
  - callLLM (lines 431-527):
```
```typescript
export async function callLLM(
  prompt: string,
  config: GeneratorConfig,
  fetchFn: typeof fetch = fetch
): Promise<string> {
  const url = 'https://openrouter.ai/api/v1/chat/completions';
  const maxRetries = 3;
  const timeout = config.timeout ?? 30000; // 30 seconds default

  const body = {
    model: config.model,
    messages: [
      { role: 'user', content: prompt }
    ],
    max_tokens: config.maxTokens ?? 1024,
  // ... (82 more lines)
```

This gives the LLM the actual code context including:
- Default timeout value (30000)
- Max retries (3)
- API URL
- Request structure
